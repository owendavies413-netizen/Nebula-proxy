<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula | Proxy</title>
    <link rel="stylesheet" href="/index.css">

    <script src="https://cdn.jsdelivr.net/npm/@mercuryworkshop/bare-mux@2.1.8/dist/index.js"></script>
    <script src="/scram/scramjet.codecs.js"></script>
    <script src="/scram/scramjet.config.js"></script>
    <script src="/scram/scramjet.all.js"></script>
    
    <script src="/js/register-sw.js" defer></script>
    <script src="/js/search.js" defer></script>
</head>
<body style="background: #0b0e14; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: sans-serif;">

    <div class="container" style="text-align: center;">
        <h1 style="letter-spacing: 5px; font-size: 3rem; margin-bottom: 20px;">NEBULA</h1>
        <form id="proxy-form" style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
            <input type="text" id="proxy-search" placeholder="Enter URL..." autocomplete="off" style="padding: 12px; border-radius: 8px; border: 1px solid #333; background: #1a1d23; color: white; width: 300px;">
            <button type="submit" style="padding: 12px 24px; background: #7289da; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Launch</button>
        </form>
        <p id="status-text" style="color: #888; font-size: 0.9em;">Synchronizing Engine...</p>
    </div>

<script>
async function bootNebula() {
    const status = document.getElementById('status-text');
    const root = window.location.origin;

    try {
        if ('serviceWorker' in navigator) {
            status.innerText = "Igniting Engine...";
            await navigator.serviceWorker.ready;
            
            if (!navigator.serviceWorker.controller) {
                status.innerText = "Syncing... Refreshing.";
                location.reload();
                return;
            }
        }

        status.innerText = "Connecting Transport...";
        const connection = new BareMux.BareMuxConnection(`${root}/baremux/worker.js`);
        
        // This links BareMux and Scramjet
        await connection.setTransport(`${root}/scram/scramjet.all.js`, [{ 
            wisp: "wss://wisp.mercuryworkshop.me/" 
        }]);

        const { ScramjetController } = $scramjetLoadController();
        const scramjet = new ScramjetController({
            prefix: '/service/',
            files: {
                wasm: `${root}/scram/scramjet.wasm.wasm`,
                all: `${root}/scram/scramjet.all.js`,
                config: `${root}/scram/scramjet.config.js`
            }
        });

        await scramjet.init();
        window.scramjet = scramjet; // Make global for search.js

        status.innerText = "ðŸš€ System Online";
        status.style.color = "#00ff00";

    } catch (err) {
        console.error("Boot Failure:", err);
        status.innerText = "Stalled. Check DevTools (F12)";
    }
}
window.addEventListener('load', bootNebula);
</script>
</body>
</html>